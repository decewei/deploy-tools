name: 'Dependabot Auto-Merge'
description: 'Auto-approve and auto-merge dependabot PRs'

inputs:
  token:
    required: true
    description: 'GitHub token for git operations (or use app-id + private-key)'
  app-id:
    required: false
    description: 'GitHub App ID (optional)'
  private-key:
    required: false
    description: 'GitHub App private key (optional)'

runs:
  using: 'composite'
  steps:
    - name: Check if dependabot PR
      shell: bash
      run: |
        if [[ "${{ github.head_ref || github.ref_name }}" == *"dependabot/"* ]]; then
          echo "Detected dependabot PR, proceeding with auto-merge"
        else
          echo "Skipping: This is not a dependabot PR"
        fi

    - name: Configure git authentication
      id: auth
      if: ${{ contains(github.head_ref || github.ref_name, 'dependabot/') }}
      uses: decewei/deploy-tools/actions/configure-git-auth@release
      with:
        token: ${{ inputs.token }}
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}

    - name: Approve dependabot PR
      if: ${{ contains(github.head_ref || github.ref_name, 'dependabot/') }}
      shell: bash
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        echo "Approving PR: ${PR_URL}"
        gh pr review --approve "${PR_URL}"
      env:
        GH_TOKEN: ${{ steps.auth.outputs.token }}

    - name: Trim PR body if needed
      if: ${{ contains(github.head_ref || github.ref_name, 'dependabot/') }}
      shell: bash
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_NUMBER=$(echo "${PR_URL}" | grep -oE '[0-9]+$')
        
        # Get PR body
        PR_BODY=$(gh pr view "${PR_NUMBER}" --json body --jq '.body' 2>/dev/null || echo "")
        BODY_LENGTH=${#PR_BODY}
        MAX_CHARS=60000
        
        if [ "${BODY_LENGTH}" -gt "${MAX_CHARS}" ]; then
          echo "PR body exceeds ${MAX_CHARS} characters (${BODY_LENGTH} chars). Trimming..."
          TRIMMED_BODY="${PR_BODY:0:${MAX_CHARS}}"
          TRIMMED_BODY="${TRIMMED_BODY}... (PR body trimmed - original body exceeds character limit)"
          gh pr edit "${PR_NUMBER}" --body "${TRIMMED_BODY}"
          echo "PR body trimmed to ${MAX_CHARS} characters"
        else
          echo "PR body is within limits (${BODY_LENGTH} chars)"
        fi
      env:
        GH_TOKEN: ${{ steps.auth.outputs.token }}

    - name: Enable auto-merge for dependabot PR
      if: ${{ contains(github.head_ref || github.ref_name, 'dependabot/') }}
      shell: bash
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        echo "Enabling auto-merge for PR: ${PR_URL}"
        gh pr merge --auto --squash "${PR_URL}"
      env:
        GH_TOKEN: ${{ steps.auth.outputs.token }}
